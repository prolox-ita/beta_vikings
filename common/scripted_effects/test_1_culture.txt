state_calculation = {	#STATE 
	every_owned_state = {
		for_each_loop = {
			array = state_culture_array_num
			
			# Sets each value in population array to percentage
			set_variable = {
			  var = state_culture_pop_array^i
			  value = state_culture_array_num^i
			}
			# Multiplies percentage with state pop to find state culture population
			multiply_variable = {
			  var = state_culture_pop_array^i
			  value = state_population_k
			}
		}
	# same thing, but for religion
		for_each_loop = {
			array = state_religion_array_num
			
			set_variable = {
			  var = state_religion_pop_array^i
			  value = state_religion_array_num^i
			}
			multiply_variable = {
			  var = state_religion_pop_array^i
			  value = state_population_k
			}
		}
	}
}

nation_calculation = {
	#COUNTRY

	every_country = {
	  # Reset Arrays
		clear_array = national_culture_array
		clear_array = national_culture_num_array
		clear_array = national_culture_pop_array
		clear_array = national_culture_percentage_array
		clear_array = national_religion_array
		clear_array = national_religion_num_array
		clear_array = national_religion_pop_array
	  
		every_owned_state = {
			for_each_loop = {
			  array = state_culture_array
			  
			  # Check if current culture is already in national array
			  if = {
				limit = {
				  is_in_array = {
					array = PREV.national_culture_array
					value = state_culture_array^i
				  }
				}
				
				# if so, find spot in array and add to it's population
				for_each_loop = {
				  array = PREV.national_culture_array
				  if = {
					limit = {
					  check_variable = {
						var = PREV.national_culture_array^i
						value = state_culture_array^i
					  }
					}
					add_to_variable = {
					  var = PREV.national_culture_pop_array^i
					  value = state_culture_array^i
					}
				  }
				}
			  }
			  # If its a new culture not in national array, make a new spot for it
			  else = {
				add_to_array = {
				  array = PREV.national_culture_array
				  value = state_culture_array^i
				}
				add_to_array = {
				  array = PREV.national_culture_pop_array
				  value = state_culture_array^i
				}
			  }
			}
		}

	##############
	# PERCENTAGE #
	##############

	#Culture percentage

		for_each_loop = {
			array = national_culture_pop_array
				
			add_to_array = {
			  array = national_culture_num_array
			  value = national_culture_pop_array^i
			}
			divide_variable = {
				var = national_culture_num_array
				value = max_manpower_k 
			}

			add_to_temp_array = {
				array = national_culture_percentage_array
				value = national_culture_num_array 
			}
		}

	#PUT IN ORDER BY HIGHEST
		for_loop_effect = {
			#array = national_culture_percentage_array
			
			find_highest_in_array = {
				array = national_culture_percentage_array
			}
			remove_from_array = {
				array = national_culture_percentage_array
			}
			add_to_array = {
				array = national_culture_ordered_perc_array #should be culture p%
				index = national_culture_percentage_array^i
			}
			#
			add_to_array = {
				array = national_culture_ordered_array #should be the culture ID
				index = national_culture_array^i
			}
			add_to_array = {
				array = national_culture_ordered_pop_array #should be culture pop
				index = national_culture_pop_array^i
			}
		}
	}
}


