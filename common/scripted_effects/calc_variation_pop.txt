change_perc_calculation = {
	every_state = {
	
		clear_array = local_culture_array
		clear_array = local_culture_perc_array
		clear_array = local_culture_pop_array
		set_variable = { tot_neigh_pop = 0 }				

		every_neighbor_state = {
			
			for_each_loop = {
				array = state_culture_ordered_array
				index = i
				value = v
				break = 1
				
				if = {
					limit = {
						AND = {
							is_in_array = {
								array = PREV.local_culture_array
								value = v
							}
						}
					}

					for_each_loop = {
						array = PREV.local_culture_array
						index = ii
						value = vv
						break = bb
						if = {
							limit = {
								check_variable = {
									v = vv
								}
							}
						
							
							add_to_variable = {
								var = PREV.local_culture_pop_array^ii
								value = state_culture_ordered_pop_array^i
							}
							set_temp_variable = { state_culture_ordered_pop_array_temp = state_culture_ordered_pop_array^i } 
							add_to_variable = { PREV.tot_neigh_pop = state_culture_ordered_pop_array_temp }
							
							
							
						}
					}
				}
				if = {
					limit = {
						AND = {
							NOT = {
								is_in_array = {
									array = PREV.local_culture_array
									value = v
								}
							}
						}
					}
						set_temp_variable = { state_culture_ordered_pop_array_temp = state_culture_ordered_pop_array^i } 
						add_to_array = { 
							array = PREV.local_culture_array
							value = state_culture_ordered_array^i
						}
						add_to_array = {
							array = PREV.local_culture_pop_array
							value = state_culture_ordered_pop_array^i
						}
						add_to_variable = { PREV.tot_neigh_pop = state_culture_ordered_pop_array_temp }
				}
				
			}
		}
		for_each_loop = {
			array = local_culture_pop_array
			index = ii
			value = vv
			
			set_temp_variable = { culture_pop^i = local_culture_pop_array^ii }
			divide_temp_variable = { culture_pop^i = tot_neigh_pop }
			add_to_array = {
				array = local_culture_perc_array
				#index = ii
				value = culture_pop^i
			}
		}
	
		set_temp_variable = { delta_pop_var = state_population_k }
		
		subtract_from_temp_variable = { delta_pop_var = old_pop_var } #I get the difference between (month) - (month-1)
		set_temp_variable = { of_neigh_pop = 0.25 }
		multiply_temp_variable = { of_neigh_pop = delta_pop_var }
		
		for_each_loop = {
			array = local_culture_perc_array
			index = ii
			value = vv
			
			set_temp_variable = { local_culture_perc_var^i = local_culture_perc_array^ii }
			multiply_variable = { local_culture_perc_var^i = of_neigh_pop }
			
			add_to_array = {
				array = state_growth_due_migration
				value = local_culture_perc_var^i
			}
		}
	}
}